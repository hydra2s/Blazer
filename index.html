<!doctype html>
<head>
    <title>WebGPU tester</title>
    <!--<script src="pako/pako_deflate.js"></script>-->
    <!--<script src="UPNG.js"></script>-->
    <script type="module" src="./blazer.js"></script>

    <meta http-equiv="origin-trial" content="AheTb7dTZtgoY8Fcsznx+0xlpDjy/teBncwVq9xG4xIf9qPWcZTOakvTzk/v7BtAeoL9xu7O87L57Lq7RhasZwgAAABeeyJvcmlnaW4iOiJodHRwOi8vbG9jYWxob3N0OjgwIiwiZmVhdHVyZSI6IlVucmVzdHJpY3RlZFNoYXJlZEFycmF5QnVmZmVyIiwiZXhwaXJ5IjoxNjg4MDgzMTk5fQ==">
</head>
<body>

    <script type="module" async>
        import {loadImage, getSharedImageData, InterWork, IDBCache} from "./blazer.js";
        
        //
        const WC = new InterWork(new Worker("./blazer.js", {type: "module"}), true);
        const {BlazerBMP} = await WC.proxy("default");

        //
        let canvas = new OffscreenCanvas(512, 512);
        let ctx = canvas.getContext("2d", { willReadFrequently: true });
        ctx.fillStyle = "rgba(255, 0, 0, 0.5)";
        ctx.fillRect(64, 64, 128, 128);

        //
        const shared = getSharedImageData(ctx,0,0,canvas.width,canvas.height);
        const blazer = await new BlazerBMP();
        await blazer.init().shared(WC.shared(shared), canvas.width, canvas.height);


        //console.time("FastBMP");
        let blob = await blazer.encode();
        //console.timeEnd("FastBMP");
        
        let cache = new IDBCache();
        let db = await cache.open("fs", {
            upgrade(db) {
                const store = db.createObjectStore('test', {
                    keyPath: 'id',
                    autoIncrement: true,
                });
                //store.createIndex('date', 'date')
            }
        });
        const store = db.store("test");
        await store.put({
            "id": "wlop",
            "blob": blob
        });
        
        document.body.appendChild(await loadImage(await (await store.get("wlop")).blob));
    </script>
</body>
</html>
