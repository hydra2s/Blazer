<!doctype html>
<head>
    <title>WebGPU tester</title>
    <!--<script src="pako/pako_deflate.js"></script>-->
    <!--<script src="UPNG.js"></script>-->
    <script src="https://cdn.sheetjs.com/crc-32-latest/package/crc32.js"></script>
    <script src="https://cdn.sheetjs.com/crc-32-latest/package/crc32c.js"></script>
    <script src="adler32.js"></script>
    <script type="module" src="./blazer.js"></script>
</head>
<body>

    <script type="module">
        import {BlazerBMP, BlazerPNG} from "./blazer.js";

        (async()=>{

        //
        let loadImage = async (url) => {
            let image = new Image();
            let promise = new Promise((resolve, reject) => {
                image.onload = ()=>{ resolve(image); };
                image.onerror = (e) => { reject(e); };
            });
            image.decoding = "async";
            image.importance = "high";
            image.loading = "eager";
            image.src = await url;

            // FOR DEBUG!
            /*
            image.width = 160;
            image.height = 120;
            image.alt = "Problematic";
            document.body.appendChild(image);
            */

            //
            return promise;
        }

        //
        let canvas = new OffscreenCanvas(512, 512);
        let ctx = canvas.getContext("2d", { willReadFrequently: true });
        ctx.fillStyle = "rgba(255, 0, 0, 0.5)";
        ctx.fillRect(64, 64, 128, 128);

        //
        let blazer = (await new BlazerBMP().init()).context(ctx, canvas.width, canvas.height);


        
        let blob = blazer.encode();
        
        
        console.time("FastBMP");
        let image = await loadImage(URL.createObjectURL(blob));
        console.timeEnd("FastBMP");
        
        

        //
        document.body.appendChild(image);

    })();
    </script>
</body>
</html>
