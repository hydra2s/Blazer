<!doctype html>
<head>
    <!-- meta -->
    <meta charset="utf-8" http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>MNG testing</title>
    <!--<script src="pako/pako_deflate.js"></script>-->
    <!--<script src="UPNG.js"></script>-->
    <script async src="deps/crc32.js"></script>
    <script async type="module" src="./blazer.js"></script>

    <!-- CSS library -->
    <link rel="preload" href="blazer.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="blazer.css"></noscript>

    <!-- Overlay scrollbars -->
    <link rel="preload" href="./overlayscrollbars/styles/overlayscrollbars.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="./overlayscrollbars/styles/overlayscrollbars.css"></noscript>
    <!--<script async type="module" src="./overlayscrollbars/overlayscrollbars.browser.es6.js"></script>-->

    <!-- Development version -->
    <script async src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" crossorigin="anonymous"></script>

    <script async type="module">
        import {  OverlayScrollbars } from './overlayscrollbars/overlayscrollbars.esm.js';
        OverlayScrollbars(document.querySelector('body'), { overflow: { x: 'hidden' } });
    </script>
</head>
<body>

    <canvas width="400" height="400" id="canvas"></canvas>

    <script type="module" async>
        import {loadImage, getSharedImageData, InterWork, provideForWorker, loadBitmapThroughput, IDBCache, OpenMNG, MNGRenderer } from "./blazer.js";

        const WC = new InterWork(provideForWorker(new Worker("./blazer.js", {type: "module"})), true);
        //const {OpenMNG} = await WC.proxy("default");
        
        
        const db = await new IDBCache().open("openmng", {
            upgrade(db) {
                const store = db.createObjectStore(location.hostname, {
                    keyPath: 'id',
                    autoIncrement: true,
                });
            }
        });
        //indexedDB.deleteDatabase("openjng");

        var mng = await new OpenMNG({
            loadBitmapThroughput: async (url)=>createImageBitmap(await loadImage(url))
        });
        //await mng.load("./img/PNGGxxxx.mng");
        //await mng.load("./img/opossum.mng");
        await mng.load("./img/clock.mng");
        //await mng.load("./img/PNGSxxxx.mng");
        //await mng.load("./img/T03SCRL.mng");

        //
        var renderer = await new MNGRenderer(mng);
        var canvas = document.getElementById("canvas");
        canvas.width = await mng.width;
        canvas.height = await mng.height;
        var ctx = canvas.getContext("2d");

        //
        while (true) {
            let F = null;
            try {
                F = await (await (await renderer.drawObjects())).getCurrentFrame();
                
            } catch(e) {
                throw e;
                break;
            }

            if (F) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(F, 0, 0);
            }

            await new Promise((r)=>requestAnimationFrame(r));
        }
    </script>
</body>
</html>